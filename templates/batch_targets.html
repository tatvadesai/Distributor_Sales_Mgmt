{% extends "layout.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12 mb-4">
        <div class="card shadow">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-th-list me-2"></i>Batch Entry</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card shadow h-100 bg-dark text-white">
                            <div class="card-header">
                                <h5 class="mb-0">Set Target For:</h5>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('save_batch_targets') }}" id="batchTargetForm">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="target_financial_year" class="form-label">Financial Year:</label>
                                            <div class="input-group">
                                                <select class="form-select" id="target_financial_year" name="financial_year" onchange="updateTargetMonths()">
                                                    {% for year in financial_years %}
                                                        <option value="{{ year }}" {% if year == selected_financial_year %}selected{% endif %}>{{ year }}</option>
                                                    {% endfor %}
                                                </select>
                                                <span class="input-group-text">
                                                    <i class="fas fa-chevron-down"></i>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="target_month" class="form-label">Month:</label>
                                            <select class="form-select" id="target_month" name="month" onchange="updateTargetDateRange()">
                                                {% for month in months %}
                                                    <option value="{{ month }}" {% if month == selected_month %}selected{% endif %}>{{ month }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="target_date_range" class="form-label">Date Range</label>
                                            <input type="text" class="form-control" id="target_date_range" name="date_range" value="{{ selected_date_range }}" readonly>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Distributor:</label>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Target:</label>
                                        </div>
                                    </div>
                                    
                                    {% for distributor in distributors %}
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="distributor_ids" value="{{ distributor.id }}" id="targetDist{{ distributor.id }}" checked>
                                                    <label class="form-check-label" for="targetDist{{ distributor.id }}">
                                                        {{ distributor.name }}
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="input-group">
                                                    <input type="number" step="0.01" min="0" class="form-control" name="target_values[{{ distributor.id }}]" placeholder="Target" 
                                                        value="{{ targets.get(distributor.id, 0) }}">
                                                    <span class="input-group-text">cases</span>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    
                                    <div class="text-center mt-3">
                                        <button type="submit" class="btn btn-success rounded-pill px-4">
                                            Save
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card shadow h-100 bg-dark text-white">
                            <div class="card-header">
                                <h5 class="mb-0">Log Sales For:</h5>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('save_batch_sales') }}" id="batchSalesForm">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="sales_financial_year" class="form-label">Financial Year:</label>
                                            <div class="input-group">
                                                <select class="form-select" id="sales_financial_year" name="financial_year" onchange="updateSalesMonths()">
                                                    {% for year in financial_years %}
                                                        <option value="{{ year }}" {% if year == selected_financial_year %}selected{% endif %}>{{ year }}</option>
                                                    {% endfor %}
                                                </select>
                                                <span class="input-group-text">
                                                    <i class="fas fa-chevron-down"></i>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="sales_month" class="form-label">Month:</label>
                                            <select class="form-select" id="sales_month" name="month" onchange="updateSalesDateRange()">
                                                {% for month in months %}
                                                    <option value="{{ month }}" {% if month == selected_month %}selected{% endif %}>{{ month }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="sales_date_range" class="form-label">Date Range</label>
                                            <input type="text" class="form-control" id="sales_date_range" name="date_range" value="{{ selected_date_range }}" readonly>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Distributor:</label>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Sales:</label>
                                        </div>
                                    </div>
                                    
                                    {% for distributor in distributors %}
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="distributor_ids" value="{{ distributor.id }}" id="salesDist{{ distributor.id }}" checked>
                                                    <label class="form-check-label" for="salesDist{{ distributor.id }}">
                                                        {{ distributor.name }}
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="input-group">
                                                    <input type="number" step="0.01" min="0" class="form-control" name="sales_values[{{ distributor.id }}]" placeholder="Sales" 
                                                        value="{{ actuals.get(distributor.id, 0) }}">
                                                    <span class="input-group-text">cases</span>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    
                                    <div class="text-center mt-3">
                                        <button type="submit" class="btn btn-success rounded-pill px-4">
                                            Save
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateTargetMonths() {
    const financialYear = document.getElementById('target_financial_year').value;
    
    fetch(`/api/months/${financialYear}`)
        .then(response => response.json())
        .then(months => {
            const monthSelect = document.getElementById('target_month');
            const currentSelection = monthSelect.value;
            monthSelect.innerHTML = '';
            
            let found = false;
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                if (month === currentSelection) {
                    option.selected = true;
                    found = true;
                }
                monthSelect.appendChild(option);
            });
            
            if (!found && months.length > 0) {
                monthSelect.value = months[0];
            }
            
            // Update date range after month is updated
            updateTargetDateRange();
        });
}

function updateTargetDateRange() {
    const financialYear = document.getElementById('target_financial_year').value;
    const month = document.getElementById('target_month').value;
    
    if (financialYear && month) {
        fetch(`/api/date_range/${financialYear}/${month}`)
            .then(response => response.json())
            .then(dateRange => {
                document.getElementById('target_date_range').value = dateRange;
            });
    }
}

function updateSalesMonths() {
    const financialYear = document.getElementById('sales_financial_year').value;
    
    fetch(`/api/months/${financialYear}`)
        .then(response => response.json())
        .then(months => {
            const monthSelect = document.getElementById('sales_month');
            const currentSelection = monthSelect.value;
            monthSelect.innerHTML = '';
            
            let found = false;
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                if (month === currentSelection) {
                    option.selected = true;
                    found = true;
                }
                monthSelect.appendChild(option);
            });
            
            if (!found && months.length > 0) {
                monthSelect.value = months[0];
            }
            
            // Update date range after month is updated
            updateSalesDateRange();
        });
}

function updateSalesDateRange() {
    const financialYear = document.getElementById('sales_financial_year').value;
    const month = document.getElementById('sales_month').value;
    
    if (financialYear && month) {
        fetch(`/api/date_range/${financialYear}/${month}`)
            .then(response => response.json())
            .then(dateRange => {
                document.getElementById('sales_date_range').value = dateRange;
            });
    }
}

// Initialize date ranges
document.addEventListener('DOMContentLoaded', function() {
    // Initialize target date range if needed
    if (document.getElementById('target_financial_year').value && 
        document.getElementById('target_month').value && 
        !document.getElementById('target_date_range').value) {
        updateTargetDateRange();
    }
    
    // Initialize sales date range if needed
    if (document.getElementById('sales_financial_year').value && 
        document.getElementById('sales_month').value && 
        !document.getElementById('sales_date_range').value) {
        updateSalesDateRange();
    }
});
</script>
{% endblock %} 