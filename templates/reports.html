{% extends "layout.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header tab-reports d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Reports</h5>
                <small class="text-white">Generate and send performance reports</small>
            </div>
            <div class="card-body">
                <form id="reportForm" class="mb-4">
                    <div class="row g-3 align-items-end mb-4">
                        <div class="col-md-3">
                            <label for="distributor_id" class="form-label">Distributor <span class="text-danger">*</span></label>
                            <select class="form-select" id="distributor_id" name="distributor_id" required>
                                <option value="">Select Distributor</option>
                                {% for distributor in distributors %}
                                    <option value="{{ distributor.id }}" {% if selected_distributor_id|int == distributor.id %}selected{% endif %}
                                        data-email="{{ distributor.email }}">
                                        {{ distributor.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="financial_year" class="form-label">Financial Year</label>
                            <select class="form-select" id="financial_year" name="financial_year" onchange="updateDateScopeOptions()">
                                {% for fy in financial_years %}
                                    <option value="{{ fy }}" {% if fy == financial_year %}selected{% endif %}>{{ fy }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="month" class="form-label">Month</label>
                            <select class="form-select" id="month" name="month" onchange="updatePeriodFromMonth()" {% if not financial_year %}disabled{% endif %}>
                                <option value="">All Months</option>
                                {% for m in months %}
                                    <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m.split('-')[0] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3" id="date_range_container">
                            <label for="date_range" class="form-label">Date Range</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="date_range" name="date_range" placeholder="Select date range" 
                                       {% if date_range %}value="{{ date_range }}"{% endif %}>
                                <button class="btn btn-outline-secondary" type="button" onclick="applyFilters()">
                                    <i class="fas fa-filter"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert" id="scope_display" style="background-color: rgba(52, 120, 122, 0.1); color: var(--reports-color); border-color: var(--reports-color);">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="scope_text">Select a period scope for reporting</span>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" id="sendToDistributorBtn" class="btn btn-primary mb-3" onclick="sendToDistributor()" style="background-color: var(--reports-color); border-color: var(--reports-color);">
                            <i class="fas fa-paper-plane me-1"></i> Send to Distributor
                        </button>
                    </div>
                </form>
                
                <div class="card mb-4">
                    <div class="card-header tab-reports">
                        <h6 class="mb-0 text-white"><i class="fas fa-download me-2"></i>Generate Reports</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-pdf fa-4x text-danger mb-3"></i>
                                        <h5>PDF Report</h5>
                                        <p class="text-muted">Generate a printable PDF report with performance metrics.</p>
                                        <form action="{{ url_for('generate_report', report_type='pdf') }}" method="post" onsubmit="return validateForm(this)">
                                            
                                            <input type="hidden" name="distributor_id" id="pdf_distributor_id">
                                            <input type="hidden" name="period_type" id="pdf_period_type">
                                            <input type="hidden" name="period_identifier" id="pdf_period_identifier">
                                            <button type="submit" class="btn btn-outline-danger">
                                                <i class="fas fa-file-pdf me-1"></i>Download PDF
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-excel fa-4x text-success mb-3"></i>
                                        <h5>Excel Report</h5>
                                        <p class="text-muted">Generate a detailed Excel report for further analysis.</p>
                                        <form action="{{ url_for('generate_report', report_type='excel') }}" method="post" onsubmit="return validateForm(this)">
                                            
                                            <input type="hidden" name="distributor_id" id="excel_distributor_id">
                                            <input type="hidden" name="period_type" id="excel_period_type">
                                            <input type="hidden" name="period_identifier" id="excel_period_identifier">
                                            <button type="submit" class="btn btn-outline-success">
                                                <i class="fas fa-file-excel me-1"></i>Download Excel
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header tab-reports">
                        <h6 class="mb-0 text-white"><i class="fas fa-paper-plane me-2"></i>Send Reports</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-envelope fa-4x text-primary mb-3"></i>
                                        <h5>Email Report</h5>
                                        <p class="text-muted">Send PDF and Excel reports directly to an email address.</p>
                                        <form action="{{ url_for('send_email_report_route') }}" method="post" onsubmit="return validateEmailForm(this)">
                                            
                                            <input type="hidden" name="distributor_id" id="email_distributor_id">
                                            <input type="hidden" name="period_type" id="email_period_type">
                                            <input type="hidden" name="period_identifier" id="email_period_identifier">
                                            <div class="mb-3">
                                                <input type="email" class="form-control" name="email" placeholder="Enter email address" required>
                                            </div>
                                            <button type="submit" class="btn btn-outline-primary">
                                                <i class="fas fa-envelope me-1"></i>Send Email
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-export fa-4x text-info mb-3"></i>
                                        <h5>Bulk Export</h5>
                                        <p class="text-muted">Generate reports for all distributors at once.</p>
                                        <form action="{{ url_for('bulk_export_reports') }}" method="post">
                                            
                                            <input type="hidden" name="period_type" id="bulk_period_type">
                                            <input type="hidden" name="period_identifier" id="bulk_period_identifier">
                                            <button type="submit" class="btn btn-outline-info" onclick="return validateBulkExport()">
                                                <i class="fas fa-file-export me-1"></i>Bulk Export
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for sending to distributor -->
<form id="sendToDistributorForm" action="{{ url_for('send_to_distributor') }}" method="post" style="display: none;">
    
    <input type="hidden" name="distributor_id" id="send_distributor_id">
    <input type="hidden" name="period_type" id="send_period_type">
    <input type="hidden" name="period_identifier" id="send_period_identifier">
</form>

<!-- Notification container -->
<div id="notification-container"></div>
{% endblock %}

{% block scripts %}
<!-- Add daterangepicker library -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

<script>
// Notification system
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    document.getElementById('notification-container').appendChild(notification);
    
    // Show notification
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Initialize daterangepicker
$(document).ready(function() {
    $('#date_range').daterangepicker({
        opens: 'left',
        autoApply: false,
        locale: {
            format: 'YYYY-MM-DD'
        },
        startDate: moment().startOf('week'),
        endDate: moment().endOf('week')
    });
    
    // Initial update of scope display
    updateScopeDisplay();
    
    // Form validation setup
    validateSelectForms();
});

// Update the scope display based on selected filters
function updateScopeDisplay() {
    const fy = $('#financial_year').val();
    const month = $('#month').val();
    const dateRange = $('#date_range').val();
    
    let scopeText = '';
    let periodType = '';
    let periodIdentifier = '';
    
    if (dateRange && dateRange !== '') {
        // Date range takes precedence
        const dates = dateRange.split(' - ');
        scopeText = `Custom period: ${dates[0]} to ${dates[1]}`;
        periodType = 'Weekly';
        periodIdentifier = dateRange;
    } else if (month && month !== '') {
        // Month selected
        scopeText = `Month: ${month}`;
        periodType = 'Monthly';
        periodIdentifier = month;
    } else if (fy && fy !== '') {
        // Only financial year selected
        scopeText = `Financial Year: ${fy}`;
        periodType = 'Yearly';
        periodIdentifier = fy.replace('FY', '');
    } else {
        scopeText = 'Select a period scope for reporting';
    }
    
    $('#scope_text').text(scopeText);
    
    // Update hidden form fields
    $('#pdf_period_type, #excel_period_type, #email_period_type, #bulk_period_type, #send_period_type').val(periodType);
    $('#pdf_period_identifier, #excel_period_identifier, #email_period_identifier, #bulk_period_identifier, #send_period_identifier').val(periodIdentifier);
    
    return { periodType, periodIdentifier };
}

// Update month options when financial year changes
function updateDateScopeOptions() {
    const fy = $('#financial_year').val();
    
    if (!fy) {
        $('#month').prop('disabled', true);
        $('#month').html('<option value="">All Months</option>');
        updateScopeDisplay();
        return;
    }
    
    // Enable month dropdown
    $('#month').prop('disabled', false);
    
    // Fetch months for this financial year
    fetch(`/api/months/${fy}`)
        .then(response => response.json())
        .then(months => {
            let html = '<option value="">All Months</option>';
            months.forEach(month => {
                html += `<option value="${month}">${month.split('-')[0]}</option>`;
            });
            $('#month').html(html);
            
            // Reset month selection
            $('#month').val('');
            
            // Update scope display
            updateScopeDisplay();
        })
        .catch(error => {
            console.error('Error fetching months:', error);
        });
    
    // Update date range picker defaults for this FY
    updateDateRangePickerDefaults(fy);
}

// Update date range picker defaults based on financial year
function updateDateRangePickerDefaults(fy) {
    if (!fy) return;
    
    // Extract year numbers from FY (e.g., "FY24-25" -> 2024, 2025)
    const fyParts = fy.replace('FY', '').split('-');
    const startYear = 2000 + parseInt(fyParts[0]);
    const endYear = 2000 + parseInt(fyParts[1]);
    
    // Set date range to full FY
    const startDate = moment(`${startYear}-04-01`);
    const endDate = moment(`${endYear}-03-31`);
    
    $('#date_range').data('daterangepicker').setStartDate(startDate);
    $('#date_range').data('daterangepicker').setEndDate(endDate);
}

// Update period when month is selected
function updatePeriodFromMonth() {
    const fy = $('#financial_year').val();
    const month = $('#month').val();
    
    if (!month) {
        // Reset to full FY
        updateDateRangePickerDefaults(fy);
        updateScopeDisplay();
        return;
    }
    
    // Parse month and set date range
    try {
        const [monthName, fyString] = month.split('-');
        const monthIndex = ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'].indexOf(monthName);
        const fyParts = fyString.replace('FY', '').split('-');
        
        let year = 2000 + parseInt(fyParts[0]);
        
        // Adjust for calendar year boundary (Jan-Mar are in the next calendar year)
        if (monthIndex >= 9) { // Jan, Feb, Mar
            year = 2000 + parseInt(fyParts[1]);
        }
        
        // Calculate month number (1-12)
        let monthNum = (monthIndex + 4) % 12;
        if (monthNum === 0) monthNum = 12;
        
        // Calculate start and end dates of the month
        const startDate = moment(new Date(year, monthNum - 1, 1));
        const endDate = moment(startDate).endOf('month');
        
        // Update daterangepicker
        $('#date_range').data('daterangepicker').setStartDate(startDate);
        $('#date_range').data('daterangepicker').setEndDate(endDate);
        
        // Clear the date range value so it doesn't override the month selection
        $('#date_range').val('');
        
        // Update scope display
        updateScopeDisplay();
    } catch (e) {
        console.error('Error parsing month:', e);
    }
}

// Apply filters and redirect to reports page with selected filters
function applyFilters() {
    const scope = updateScopeDisplay();
    const distributorId = $('#distributor_id').val() || '';
    
    if (!scope.periodType || !scope.periodIdentifier) {
        showNotification('Please select a valid reporting period', 'error');
        return;
    }
    
    // Redirect to reports page with filters
    window.location.href = `/reports?distributor_id=${distributorId}&period_type=${scope.periodType}&period_identifier=${scope.periodIdentifier}`;
}

// Validate form before submission
function validateForm(form) {
    const distributorId = $('#distributor_id').val();
    const scope = updateScopeDisplay();
    
    if (!distributorId) {
        showNotification('Please select a distributor', 'error');
        return false;
    }
    
    if (!scope.periodType || !scope.periodIdentifier) {
        showNotification('Please select a valid reporting period', 'error');
        return false;
    }
    
    // Set form values
    $(form).find('input[name="distributor_id"]').val(distributorId);
    
    return true;
}

// Validate email form
function validateEmailForm(form) {
    if (!validateForm(form)) {
        return false;
    }
    
    const email = $(form).find('input[name="email"]').val();
    if (!email) {
        showNotification('Please enter an email address', 'error');
        return false;
    }
    
    return true;
}

// Validate bulk export
function validateBulkExport() {
    const scope = updateScopeDisplay();
    
    if (!scope.periodType || !scope.periodIdentifier) {
        showNotification('Please select a valid reporting period', 'error');
        return false;
    }
    
    return true;
}

// Send report to distributor
function sendToDistributor() {
    const distributorId = $('#distributor_id').val();
    const distributorOption = $('#distributor_id option:selected');
    const distributorEmail = distributorOption.data('email');
    const scope = updateScopeDisplay();
    
    if (!distributorId) {
        showNotification('Please select a distributor', 'error');
        return false;
    }
    
    if (!scope.periodType || !scope.periodIdentifier) {
        showNotification('Please select a valid reporting period', 'error');
        return false;
    }
    
    if (!distributorEmail) {
        showNotification('Selected distributor does not have an email address', 'error');
        return false;
    }
    
    // Confirm before sending
    if (confirm(`Send reports to ${distributorOption.text()} (${distributorEmail})?`)) {
        // Set form values
        $('#send_distributor_id').val(distributorId);
        $('#sendToDistributorForm').submit();
    }
    
    return false;
}

// Set up form validation for selector values
function validateSelectForms() {
    $('#distributor_id').on('change', function() {
        const id = $(this).val();
        $('#pdf_distributor_id, #excel_distributor_id, #email_distributor_id, #send_distributor_id').val(id);
    });
    
    // Trigger initial update
    $('#distributor_id').trigger('change');
}
</script>
{% endblock %}
