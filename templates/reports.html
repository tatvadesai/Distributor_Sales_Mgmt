{% extends "layout.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Reports</h5>
                <small class="text-white">Generate and send performance reports</small>
            </div>
            <div class="card-body">
                <!-- Include the filter component -->
                {% with filter_action=url_for('reports') %}
                    {% include 'filter_component.html' %}
                {% endwith %}
                
                <div class="d-flex justify-content-end mb-4">
                    <button type="button" id="sendToDistributorBtn" class="btn btn-success" onclick="sendToDistributor()">
                        <i class="fas fa-paper-plane me-1"></i> Send to Distributor
                    </button>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-download me-2"></i>Generate Reports</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-pdf fa-4x text-danger mb-3"></i>
                                        <h5>PDF Report</h5>
                                        <p class="text-muted">Generate a printable PDF report with performance metrics.</p>
                                        <form action="{{ url_for('generate_report', report_type='pdf') }}" method="post" onsubmit="return validateForm(this)">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="distributor_id" id="pdf_distributor_id">
                                            <input type="hidden" name="financial_year" id="pdf_financial_year">
                                            <input type="hidden" name="month" id="pdf_month">
                                            <button type="submit" class="btn btn-outline-danger">
                                                <i class="fas fa-file-pdf me-1"></i>Download PDF
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-excel fa-4x text-success mb-3"></i>
                                        <h5>Excel Report</h5>
                                        <p class="text-muted">Generate a detailed Excel report for further analysis.</p>
                                        <form action="{{ url_for('generate_report', report_type='excel') }}" method="post" onsubmit="return validateForm(this)">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="distributor_id" id="excel_distributor_id">
                                            <input type="hidden" name="financial_year" id="excel_financial_year">
                                            <input type="hidden" name="month" id="excel_month">
                                            <button type="submit" class="btn btn-outline-success">
                                                <i class="fas fa-file-excel me-1"></i>Download Excel
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-paper-plane me-2"></i>Send Reports</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-envelope fa-4x text-primary mb-3"></i>
                                        <h5>Email Report</h5>
                                        <p class="text-muted">Send PDF and Excel reports directly to an email address.</p>
                                        <form action="{{ url_for('send_email_report_route') }}" method="post" onsubmit="return validateEmailForm(this)">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="distributor_id" id="email_distributor_id">
                                            <input type="hidden" name="financial_year" id="email_financial_year">
                                            <input type="hidden" name="month" id="email_month">
                                            <div class="mb-3">
                                                <input type="email" class="form-control" name="email" placeholder="Enter email address" required>
                                            </div>
                                            <button type="submit" class="btn btn-outline-primary">
                                                <i class="fas fa-envelope me-1"></i>Send Email
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-export fa-4x text-info mb-3"></i>
                                        <h5>Bulk Export</h5>
                                        <p class="text-muted">Generate reports for all distributors at once.</p>
                                        <form action="{{ url_for('bulk_export_reports') }}" method="post">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="financial_year" id="bulk_financial_year">
                                            <input type="hidden" name="month" id="bulk_month">
                                            <button type="submit" class="btn btn-outline-info" onclick="return validateBulkExport()">
                                                <i class="fas fa-file-export me-1"></i>Bulk Export
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form for sending to distributor -->
<form id="sendToDistributorForm" action="{{ url_for('send_to_distributor') }}" method="post" style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="distributor_id" id="send_distributor_id">
    <input type="hidden" name="financial_year" id="send_financial_year">
    <input type="hidden" name="month" id="send_month">
</form>
{% endblock %}

{% block scripts %}
<script>
function validateForm(form) {
    // Get values from the main form
    const distributorId = document.getElementById('distributor_id').value;
    const financialYear = document.getElementById('financial_year').value;
    const month = document.getElementById('month').value;
    
    // Set values in the hidden form
    form.querySelector('[name="distributor_id"]').value = distributorId;
    form.querySelector('[name="financial_year"]').value = financialYear;
    form.querySelector('[name="month"]').value = month;
    
    // Validate required fields
    if (!distributorId) {
        alert('Please select a distributor');
        return false;
    }
    
    return true;
}

function validateEmailForm(form) {
    // Validate the form first
    if (!validateForm(form)) {
        return false;
    }
    
    // Check email
    const email = form.querySelector('[name="email"]').value;
    if (!email) {
        alert('Please enter an email address');
        return false;
    }
    
    return true;
}

function validateBulkExport() {
    const financialYear = document.getElementById('financial_year').value;
    const month = document.getElementById('month').value;
    
    // Set values in the hidden form
    document.getElementById('bulk_financial_year').value = financialYear;
    document.getElementById('bulk_month').value = month;
    
    return true;
}

function sendToDistributor() {
    const distributorId = document.getElementById('distributor_id').value;
    const financialYear = document.getElementById('financial_year').value;
    const month = document.getElementById('month').value;
    
    if (!distributorId) {
        alert('Please select a distributor');
        return;
    }
    
    // Set values in the hidden form
    document.getElementById('send_distributor_id').value = distributorId;
    document.getElementById('send_financial_year').value = financialYear;
    document.getElementById('send_month').value = month;
    
    // Submit the form
    document.getElementById('sendToDistributorForm').submit();
}

// When page loads, set initial values
document.addEventListener('DOMContentLoaded', function() {
    // Sync hidden form fields with selected values
    const distributorId = document.getElementById('distributor_id').value;
    const financialYear = document.getElementById('financial_year').value;
    const month = document.getElementById('month').value;
    
    // Set hidden fields for PDF form
    document.getElementById('pdf_distributor_id').value = distributorId;
    document.getElementById('pdf_financial_year').value = financialYear;
    document.getElementById('pdf_month').value = month;
    
    // Set hidden fields for Excel form
    document.getElementById('excel_distributor_id').value = distributorId;
    document.getElementById('excel_financial_year').value = financialYear;
    document.getElementById('excel_month').value = month;
    
    // Set hidden fields for Email form
    document.getElementById('email_distributor_id').value = distributorId;
    document.getElementById('email_financial_year').value = financialYear;
    document.getElementById('email_month').value = month;
    
    // Set hidden fields for Bulk Export form
    document.getElementById('bulk_financial_year').value = financialYear;
    document.getElementById('bulk_month').value = month;
});
</script>
{% endblock %}
