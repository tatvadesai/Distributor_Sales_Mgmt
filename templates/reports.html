{% extends "layout.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Performance Reports</h5>
            </div>
            <div class="card-body">
                <!-- Include the filter component -->
                {% with filter_action=url_for('reports') %}
                    {% include 'filter_component.html' %}
                {% endwith %}
                
                <!-- Period information -->
                <div class="alert alert-info mb-4">
                    <h6 class="mb-1"><i class="fas fa-calendar-alt me-2"></i>Report for: 
                    {% if selected_month == 'All' %}
                        Entire Financial Year {{ selected_financial_year }}
                    {% else %}
                        {{ selected_month }} {{ selected_financial_year }} {% if selected_date_range %} ({{ selected_date_range }}){% endif %}
                    {% endif %}
                    </h6>
                    <small>Choose export format below to generate reports for the selected period.</small>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-download me-2"></i>Generate Reports</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-pdf fa-4x text-danger mb-3"></i>
                                        <h5>PDF Report</h5>
                                        <p class="text-muted">Generate a printable PDF report with performance metrics.</p>
                                        <form action="{{ url_for('generate_report', report_type='pdf') }}" method="post" onsubmit="return validateForm(this)">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="distributor_id" id="pdf_distributor_id" value="{{ selected_distributor_id if selected_distributor_id else '' }}">
                                            <input type="hidden" name="financial_year" id="pdf_financial_year" value="{{ selected_financial_year }}">
                                            <input type="hidden" name="month" id="pdf_month" value="{{ selected_month }}">
                                            <input type="hidden" name="date_range" id="pdf_date_range" value="{{ selected_date_range }}">
                                            <button type="submit" class="btn btn-outline-danger">
                                                <i class="fas fa-file-pdf me-1"></i>Download PDF
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-excel fa-4x text-success mb-3"></i>
                                        <h5>Excel Report</h5>
                                        <p class="text-muted">Generate an Excel spreadsheet with performance data and charts.</p>
                                        <form action="{{ url_for('generate_report', report_type='excel') }}" method="post" onsubmit="return validateForm(this)">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="distributor_id" id="excel_distributor_id" value="{{ selected_distributor_id if selected_distributor_id else '' }}">
                                            <input type="hidden" name="financial_year" id="excel_financial_year" value="{{ selected_financial_year }}">
                                            <input type="hidden" name="month" id="excel_month" value="{{ selected_month }}">
                                            <input type="hidden" name="date_range" id="excel_date_range" value="{{ selected_date_range }}">
                                            <button type="submit" class="btn btn-outline-success">
                                                <i class="fas fa-file-excel me-1"></i>Download Excel
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-envelope me-2"></i>Email Reports</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-paper-plane fa-4x text-primary mb-3"></i>
                                        <h5>Email Report</h5>
                                        <p class="text-muted">Send report via email to any address.</p>
                                        <form action="{{ url_for('send_email_report_route') }}" method="post" onsubmit="return validateEmailForm(this)">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="distributor_id" id="email_distributor_id" value="{{ selected_distributor_id if selected_distributor_id else '' }}">
                                            <input type="hidden" name="financial_year" id="email_financial_year" value="{{ selected_financial_year }}">
                                            <input type="hidden" name="month" id="email_month" value="{{ selected_month }}">
                                            <div class="mb-3">
                                                <input type="email" class="form-control" name="email" placeholder="Email address" required>
                                            </div>
                                            <button type="submit" class="btn btn-outline-primary">
                                                <i class="fas fa-paper-plane me-1"></i>Send Report
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-truck fa-4x text-secondary mb-3"></i>
                                        <h5>Send to Distributor</h5>
                                        <p class="text-muted">Send report directly to the selected distributor.</p>
                                        <form action="{{ url_for('send_to_distributor') }}" method="post" onsubmit="return validateDistributorForm(this)">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="distributor_id" id="dist_distributor_id" value="{{ selected_distributor_id if selected_distributor_id else '' }}">
                                            <input type="hidden" name="financial_year" id="dist_financial_year" value="{{ selected_financial_year }}">
                                            <input type="hidden" name="month" id="dist_month" value="{{ selected_month }}">
                                            <button type="submit" class="btn btn-outline-secondary">
                                                <i class="fas fa-truck me-1"></i>Send to Distributor
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Utility validation functions
function validateForm(form) {
    var distributorId = form.querySelector('[name="distributor_id"]').value;
    var month = form.querySelector('[name="month"]').value;
    var financialYear = form.querySelector('[name="financial_year"]').value;
    
    if (!distributorId) {
        alert("Please select a distributor.");
        return false;
    }
    
    if (!month || !financialYear) {
        alert("Please select both month and financial year.");
        return false;
    }
    
    return true;
}

function validateEmailForm(form) {
    var distributorId = form.querySelector('[name="distributor_id"]').value;
    var month = form.querySelector('[name="month"]').value;
    var financialYear = form.querySelector('[name="financial_year"]').value;
    var email = form.querySelector('[name="email"]').value;
    
    if (!distributorId) {
        alert("Please select a distributor.");
        return false;
    }
    
    if (!month || !financialYear) {
        alert("Please select both month and financial year.");
        return false;
    }
    
    if (!email) {
        alert("Please enter an email address.");
        return false;
    }
    
    return true;
}

function validateDistributorForm(form) {
    var distributorId = form.querySelector('[name="distributor_id"]').value;
    var month = form.querySelector('[name="month"]').value;
    var financialYear = form.querySelector('[name="financial_year"]').value;
    
    if (!distributorId) {
        alert("Please select a distributor.");
        return false;
    }
    
    if (!month || !financialYear) {
        alert("Please select both month and financial year.");
        return false;
    }
    
    return true;
}

// When the form fields change, update all the hidden form fields
document.addEventListener('DOMContentLoaded', function() {
    // Get filter form
    var filterForm = document.getElementById('filterForm');
    
    if (filterForm) {
        var financialYearSelect = filterForm.querySelector('[name="financial_year"]');
        var monthSelect = filterForm.querySelector('[name="month"]');
        var dateRangeInput = filterForm.querySelector('[name="date_range"]');
        var distributorSelect = filterForm.querySelector('[name="distributor_id"]');
        
        // Update hidden fields when filter form changes
        function updateHiddenFields() {
            var financialYear = financialYearSelect.value;
            var month = monthSelect.value;
            var dateRange = dateRangeInput.value;
            var distributorId = distributorSelect.value;
            
            // Update PDF form
            document.getElementById('pdf_financial_year').value = financialYear;
            document.getElementById('pdf_month').value = month;
            document.getElementById('pdf_date_range').value = dateRange;
            document.getElementById('pdf_distributor_id').value = distributorId;
            
            // Update Excel form
            document.getElementById('excel_financial_year').value = financialYear;
            document.getElementById('excel_month').value = month;
            document.getElementById('excel_date_range').value = dateRange;
            document.getElementById('excel_distributor_id').value = distributorId;
            
            // Update Email form
            document.getElementById('email_financial_year').value = financialYear;
            document.getElementById('email_month').value = month;
            document.getElementById('email_distributor_id').value = distributorId;
            
            // Update Distributor form
            document.getElementById('dist_financial_year').value = financialYear;
            document.getElementById('dist_month').value = month;
            document.getElementById('dist_distributor_id').value = distributorId;
        }
        
        // Add change event listeners to form elements
        financialYearSelect.addEventListener('change', updateHiddenFields);
        monthSelect.addEventListener('change', updateHiddenFields);
        dateRangeInput.addEventListener('change', updateHiddenFields);
        distributorSelect.addEventListener('change', updateHiddenFields);
        
        // Initialize hidden fields with current values
        updateHiddenFields();
    }
});
</script>
{% endblock %}
